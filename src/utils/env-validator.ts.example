/**
 * Environment Variable Validator - EXAMPLE/MOCKUP
 * 
 * This is a mockup/example file showing the environment variable validator structure.
 * 
 * Status: Not yet implemented (Phase 0 MVP)
 * 
 * To implement:
 * 1. Copy this file to src/utils/env-validator.ts
 * 2. Implement validation function
 * 3. Call validateEnv() at application startup (src/index.ts)
 * 4. Add tests for environment validation
 * 
 * @file src/utils/env-validator.ts.example
 * @see TODO.md - Item 1: Error Handling and Input Validation, Item 4: Configuration
 */

import { z } from 'zod';
import { ConfigurationError } from './error-handler.js';

/**
 * Environment Schema
 * 
 * Defines required and optional environment variables.
 */
const EnvSchema = z.object({
  // REQUIRED: OpenAI API Key
  OPENAI_API_KEY: z.string().min(1, 'OPENAI_API_KEY is required').startsWith('sk-', 'Invalid API key format'),
  
  // OPTIONAL: Model Selection
  OPENAI_MODEL: z.string().default('gpt-4o-mini'),
  
  // OPTIONAL: Agent Configuration
  AGENT_MAX_STEPS: z.string().default('3').transform((val) => parseInt(val, 10)),
  
  // OPTIONAL: Logging
  LOG_LEVEL: z.enum(['debug', 'info', 'warn', 'error']).default('info'),
  NODE_ENV: z.enum(['development', 'production', 'test']).default('development'),
  
  // OPTIONAL: Phase 1+ Configuration (commented out until needed)
  // DATABASE_URL: z.string().url().optional(),
  // REDIS_URL: z.string().url().optional(),
  // PINECONE_API_KEY: z.string().optional(),
  // DATADOG_API_KEY: z.string().optional(),
});

/**
 * Environment Type
 * 
 * TypeScript type inferred from EnvSchema.
 */
export type Env = z.infer<typeof EnvSchema>;

/**
 * Validate Environment Variables
 * 
 * Validates all environment variables against the schema.
 * Should be called at application startup.
 * 
 * @returns Validated environment variables
 * @throws ConfigurationError if validation fails
 * 
 * @example
 * ```typescript
 * import { validateEnv } from './utils/env-validator.js';
 * 
 * (async () => {
 *   try {
 *     const env = validateEnv();
 *     console.log('Environment validated successfully');
 *     // Continue with application startup
 *   } catch (error) {
 *     console.error('Failed to start application:', error);
 *     process.exit(1);
 *   }
 * })();
 * ```
 */
export function validateEnv(): Env {
  try {
    return EnvSchema.parse(process.env);
  } catch (error) {
    if (error instanceof z.ZodError) {
      const missingVars = error.errors
        .map(e => `${e.path.join('.')}: ${e.message}`)
        .join(', ');
      
      throw new ConfigurationError(
        `Missing or invalid environment variables: ${missingVars}\n` +
        `Please check your .env file or create one from .env.example`,
        {
          errors: error.errors,
          received: process.env,
        }
      );
    }
    throw error;
  }
}

/**
 * Get Environment Variable (with default)
 * 
 * Gets an environment variable with an optional default value.
 * 
 * @param key - Environment variable key
 * @param defaultValue - Default value if key is not set
 * @returns Environment variable value or default
 */
export function getEnv(key: string, defaultValue?: string): string {
  return process.env[key] || defaultValue || '';
}

/**
 * Require Environment Variable
 * 
 * Gets an environment variable and throws if not set.
 * 
 * @param key - Environment variable key
 * @returns Environment variable value
 * @throws ConfigurationError if variable is not set
 */
export function requireEnv(key: string): string {
  const value = process.env[key];
  if (!value) {
    throw new ConfigurationError(`Required environment variable ${key} is not set`, {
      key,
    });
  }
  return value;
}

